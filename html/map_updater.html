<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Node updater</title>
</head>

<body>
    <h1>Map Node Updater</h1>
    <h2>To download the new map node follow the steps below.</h2>
    <h2>The extension can't manipulate local user files outside the Chrome storage, so you have to do it manually.</h2>
    <h2>Even tho the map nodes file belongs to the extension, it is still outside the Chrome storage.</h2>
    <ul>
        <li>Load Stream Raiders</li>
        <li>Right-click and select Inspect Elements</li>
        <li>Go to the Network tab</li>
        <li>Search for "data.". It will look like this: data.xxxxxxx.json</li>
        <li>Copy the link</li>
        <li>Download the JSON file</li>
        <li>Replace the downloaded loyalty_chests.json file on the /extension_folder/icons</li>
        <li>Your map nodes are now up to date.</li>
    </ul>
    <form id="transformForm">
        <label for="urlInput">Insert URL you copied here:</label>
        <input type="text" id="urlInput" name="urlInput" required>
        <br>
        <label for="jsonFileInput">Select JSON file you downloaded here:</label>
        <input type="file" id="jsonFileInput" name="jsonFileInput" accept=".json" required>
        <br>
        <br>
        <button type="button" onclick="transformJson()">Download formatted JSON</button>
    </form>
    <pre id="transformedJson"></pre>

    <script>
        async function transformJson() {
            const urlInput = document.getElementById('urlInput').value;
            const jsonFileInput = document.getElementById('jsonFileInput').files[0];

            try {
                const jsonData = await readFileAsync(jsonFileInput);
                const parsedJson = JSON.parse(jsonData);

                //Extract MapNodes from the json
                const mapNodes = parsedJson.sheets.MapNodes;

                //Remove unwanted keys from each map node
                for (const nodeKey in mapNodes) {
                    const node = mapNodes[nodeKey];
                    for (const keyToRemove of ["NodeDifficulty", "MapTags", "OnLoseDialog", "OnStartDialog", "OnWinDialog"]) {
                        delete node[keyToRemove];
                    }
                }

                //Create the transformed JSON
                const transformedJson = {
                    url: urlInput,
                    MapNodes: mapNodes
                };

                //Convert the JSON to a Blob
                const blob = new Blob([JSON.stringify(transformedJson, null, 2)], { type: 'application/json' });

                //Create a download link
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.download = 'loyalty_chests.json';

                //Trigger the download
                downloadLink.click();
            } catch (error) {
                console.error(error.message);
            }
        }

        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }
    </script>

</body>

</html>